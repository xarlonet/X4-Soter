# X4 SORTER — автоматический сортировщик файлов

- X4 SORTER — это локальная утилита для автоматического отслеживания и сортировки файлов из папки (по умолчанию Downloads) в структурированную папку назначения. Поддерживает детекцию дубликатов, карантин подозрительных файлов, авто-распаковку архивов, интеграцию с Telegram и удобный веб-дашборд + TUI/Tray.

Основные возможности
- Наблюдение за папкой (watchdog) и мгновенная обработка новых файлов.
- Сортировка по типам (изображения, видео, документы и т.д.) на основе расширений.
- Сортировка по дате: EXIF/метаданные/дата создания — вложенные папки ГОД / MM_Месяц.
- Сортировка по метаданным (например, MP3 -> Artist/Album папки).
- Авто-распаковка архивов (zip/tar/...) в отдельные папки.
- Детекция дубликатов по SHA256 и перемещение их в папку 98_Дубликаты.
- Карантин (97_Карантин) для опасных расширений (.exe, .bat и т.д.).
- Период хранения / автоматическая очистка (retention) для карантина и дубликатов.
- Уведомления: системные Pop-up (plyer), звуковые оповещения (Windows), текстовые уведомления в Telegram.
- Возможность загрузки обработанных файлов в Telegram (ограничение по размеру настраивается).
- Веб-дашборд (Flask) для управления и просмотра логов/статистики.
- Системный трей (pystray) с возможностью паузы, сканирования и открытия дашборда.
- TUI-интерфейс (rich) для локальной работы в консоли.
- Легкая настройка тем оформления дашборда.

Установка и зависимости
- Требуемые Python-пакеты:
  - watchdog, rich, plyer, pystray, Pillow, Flask, mutagen, requests
- Пример установки:

> pip install watchdog rich plyer pystray Pillow Flask mutagen requests


Запуск
- Запустить в консоли:

> python main.py

- Веб-дашборд доступен по умолчанию на:

> http://127.0.0.1:5000/


Что делает программа
- Отслеживает указанную папку-источник и при появлении новых файлов:
  - Игнорирует временные/системные файлы (настраиваемый ignore_list).
  - Сравнивает хэш (SHA256) с файлами в целевой папке — если совпадение, перемещает файл в 98_Дубликаты и отправляет уведомление (по настройке).
  - Если расширение в карантинном списке — перемещает в 97_Карантин с логированием и уведомлением.
  - Пытается подразделить файлы по категориям (EXTENSIONS_DB), при необходимости создает вложенные папки по году/месяцу.
  - Для музыки (MP3) может создавать вложенные папки Artist/Album по ID3.
  - Для архивов (если включена auto_unpack) — распаковывает содержимое в отдельную папку и перемещает сам архив внутрь.
- Периодически (каждые 24 часа) выполняет политику хранения (удаляет старые файлы из карантина/дубликатов) и чистит пустые папки (deep_clean).

Структура папок, создаваемая по умолчанию
- <base_destination>/
  - 01_Изображения/
  - 02_Видео/
  - 03_Документы/
  - ...
  - 97_Карантин/
  - 98_Дубликаты/
- Для каждой категории при включенной сортировке по дате добавляются подпапки: <Год>/<MM_Месяц>

Настройки (описание полей settings_rus.json)
- theme — тема дашборда (Hacker, Cyberpunk, Ocean, Royal)
- first_run_date — дата первого запуска
- source_folder — папка, которую мониторит программа (по умолчанию Downloads)
- base_destination — корневая папка назначения (по умолчанию папка скрипта)
- stats — статистика (total_files, last_run, file_type_counts и т.д.)
- features — набор флагов:
  - sort_by_date: сортировать по дате (EXIF/создание)
  - sound_enabled: звуковые оповещения (Windows)
  - notifications: системные уведомления (plyer)
  - auto_unpack: распаковка архивов
  - deep_clean: удалять пустые папки / очищать
  - deduplication: детекция дубликатов по хэшу
  - quarantine_mode: включить режим карантина (черный список расширений)
  - retention_days: число дней хранения в карантине/дубликатах (0 = не удалять)
  - sort_by_metadata: сортировка по метаданным (MP3 Artist/Album)
- telegram — настройки Telegram:
  - enabled: включить уведомления в Telegram (текст)
  - token: Bot token
  - chat_id: chat id для отправки уведомлений
  - upload_enabled: разрешить загрузку файлов в Telegram
  - upload_max_size_mb: максимальный размер файла для загрузки (MB)
  - notify_duplicate / notify_quarantine / notify_success: включить/отключить разные типы уведомлений
- quarantine_blacklist — список расширений, отправляемых в карантин
- ignore_list — список расширений/имен для игнорирования

Пример minimal settings_rus.json

{
  "theme": "Cyberpunk",
  "source_folder": "C:\\Users\\User\\Downloads",
  "base_destination": "C:\\X4Sorter",
  "features": {
    "sort_by_date": true,
    "sound_enabled": true,
    "notifications": true,
    "auto_unpack": false,
    "deep_clean": true,
    "deduplication": true,
    "quarantine_mode": true,
    "retention_days": 30,
    "sort_by_metadata": true
  },
  "telegram": {
    "enabled": false,
    "token": "",
    "chat_id": "",
    "upload_enabled": false,
    "upload_max_size_mb": 45,
    "notify_duplicate": true,
    "notify_quarantine": true,
    "notify_success": true
  }
}


Веб-дашборд
- Реализован на Flask.
- Позволяет:
  - Просмотреть логи и статистику (последние записи).
  - Запустить принудительное сканирование.
  - Поставить на паузу / возобновить.
  - Изменить основные настройки (папки, тему, флаги, Telegram) и применить их немедленно.
- Запускается автоматически в отдельном потоке при старте программы.

Tray / Автозапуск (Windows)
- При запуске через pythonw.exe и запуске BAT в автозагрузке программа может работать в системном трее (pystray).
- Трей-меню: пауза/возобновление, открыть веб-дашборд, принудительное сканирование, выход.

Логи и статистика
- Лог-файл: history.log (в каталоге скрипта)
- Статистика по типам файлов хранится в настройках (cfg.data['stats']['file_type_counts']).
- Веб-дашборд отображает последние логи и ключевые метрики.

Безопасность и советы
- По умолчанию опасные расширения (.exe, .bat, .vbs, .js, .apk, .msi) находятся в quarantine_blacklist — рекомендуется не отключать карантин, если вы принимаете файлы из ненадежных источников.
- Перед включением upload_enabled для Telegram убедитесь, что токен и chat_id заданы и что вы не нарушаете лимиты и политику хранения Telegram.
- Рекомендуется периодически резервировать settings_rus.json и history.log при изменениях конфигурации.

Отладка
- Если Flask не запускается, возможно порт 5000 занят — изменить константу WEB_PORT в коде.
- При ошибках импорта — установить зависимости через pip (см. раздел «Установка»).
- Журналы пишутся в history.log — смотрите их для диагностики ошибок перемещения/распаковки.
